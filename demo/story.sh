#!/bin/sh
################################################################
# Copyright (c) 2016 KASHIMA Hiroaki <kashima@jp.fujitsu.com>
# æœ¬ãƒ„ãƒ¼ãƒ«ã¯ Apache License 2.0 ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã§å…¬é–‹ã—ã¾ã™ã€‚
# è‘—ä½œæ¨©ã«ã¤ã„ã¦ã¯ ./LICENSE ã‚‚ã”ç¢ºèªãã ã•ã„

        screen -X -p 7 stuff "cat > /dev/null\n"
        screen -X -p 7 stuff "NW-DIY ã®ãƒ‡ãƒ¢ã‚’è¡Œãªã„ã¾ã™ã€‚\n"
sleep 1;screen -X -p 7 stuff "ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚\n"
sleep 2;screen -X -p 7 stuff "ç”»é¢ä¸­å¤®ã®è£…ç½®ã§ã‚¹ã‚¤ãƒƒãƒã‚’å‹•ã‹ã—ã¦\n"
sleep 2;screen -X -p 7 stuff "ä¸Šã®è£…ç½®ã‹ã‚‰ä¸‹ã®è£…ç½®ã¸ã® ping ã‚’é€šã—ã¾ã™ã€‚\n"
sleep 2;screen -X -p 7 stuff "ã“ã®ã‚¹ã‚¤ãƒƒãƒã«ç°¡å˜ãªæ”¹é€ ã‚’åŠ ãˆã‚‹ã ã‘ã§\n"
sleep 2;screen -X -p 7 stuff "æ–°ã—ã„æ©Ÿèƒ½ãŒæœ‰åŠ¹ã«ãªã‚‹æ§˜å­ã‚’ã”è¦§ãã ã•ã„ã€‚\n"
sleep 2;screen -X -p 7 stuff "\nã¾ãšã€ãƒ‡ãƒ¢ç’°å¢ƒã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚\n"
sleep 2;screen -X -p 7 stuff "ä¸­å¤®ã®è£…ç½®ã¯ã€å‘¨å›²ã®æ±è¥¿å—åŒ—ã®è£…ç½®ã«å¯¾ã—ã¦\n"
sleep 2;screen -X -p 7 stuff "east0, west0, south0, north0 ã¨ã„ã†\n"
sleep 2;screen -X -p 7 stuff "ã‚¤ãƒ¼ã‚µãƒãƒƒãƒˆã§æ¥ç¶šã—ã¦ã„ã¾ã™ã€‚\n"
sleep 2;screen -X -p 7 stuff "å‘¨å›²ã®è£…ç½®ã¯ã€ä¸­å¤®ã®è£…ç½®ã«å¯¾ã—ã¦\n"
sleep 2;screen -X -p 7 stuff "center0 ã¨ã„ã†ã‚¤ãƒ¼ã‚µãƒãƒƒãƒˆã§æ¥ç¶šã—ã¦ã„ã¾ã™ã€‚\n"
sleep 2;screen -X -p 7 stuff "ãªãŠã€\n"
sleep 2;screen -X -p 7 stuff "å³ä¸Šã¯ä¸­å¤®ã®è£…ç½®ã®ã‚¨ãƒ‡ã‚£ã‚¿ç”»é¢ã§ã™ã€‚\n"
sleep 3;screen -X -p 7 stuff "\nãã‚Œã§ã¯ãƒ‡ãƒ¢ã‚’è¡Œãªã„ã¾ã™ã€‚\n"
sleep 2;screen -X -p 7 stuff "\nã¾ãšã€ãªã«ã‚‚å‹•ã„ã¦ã„ãªã„ç’°å¢ƒã§ã€\n"
sleep 2;screen -X -p 7 stuff "north ã‹ã‚‰ south ã« ping ã‚’æ‰“ã¡ã¾ã™ã€‚\n"
sleep 1;screen -X -p 8 stuff "ping 10.0.0.2\n"
sleep 3;screen -X -p 7 stuff "ä»–ã®æ©Ÿå™¨ã§ã¯ tcpdump ã‚’ä»•æ›ã‘ã¦ãŠãã¾ã™ã€‚\n"
sleep 1;screen -X -p 2 stuff "tcpdump -ni center0\n"
sleep 1;screen -X -p 4 stuff "tcpdump -ni center0\n"
sleep 1;screen -X -p 6 stuff "tcpdump -ni center0\n"
sleep 3;screen -X -p 7 stuff "center ãŒã„ã‚‹ã®ã§å±Šãã¾ã›ã‚“ã­ã€‚\n"
sleep 2;screen -X -p 7 stuff "ãã‚Œã§ã¯ center ã§ã‚¹ã‚¤ãƒƒãƒã‚’å‹•ã‹ã—ã¾ã™ã€‚\n"
sleep 2;screen -X -p 7 stuff "ãã®ãŸã‚ã®ã‚¹ã‚¤ãƒƒãƒã‚’ä½œã‚Šã¾ã—ã‚‡ã†ã€‚\n"
sleep 3;screen -X -p 9 stuff "rm switch.rb; vi switch.rb\n"
sleep 1;screen -X -p 9 stuff "i"
sleep 1;screen -X -p 9 stuff "require_relative '../lib/nwdiy'\n"
sleep 1;screen -X -p 9 stuff "require 'nwdiy/vm'\n"
sleep 1;screen -X -p 9 stuff "\n"
sleep 1;screen -X -p 9 stuff "class Switch < NwDiy::VM\n"
sleep 3;screen -X -p 7 stuff "Switch ã‚¯ãƒ©ã‚¹ã§ã‚¹ã‚¤ãƒƒãƒã‚’ä½œã‚Šã¾ã™\n"
sleep 3;screen -X -p 9 stuff "  def job\n"
sleep 1;screen -X -p 9 stuff "    loop do\n"
sleep 3;screen -X -p 7 stuff "job ã¨ã„ã†ãƒ¡ã‚½ãƒƒãƒ‰ã§ãƒ«ãƒ¼ãƒ—ã‚’ã¾ã‚ã—ã¾ã™ã€‚\n"
sleep 3;screen -X -p 9 stuff "      rifp, pkt = self.recv     # å—ä¿¡ã—ãŸã‚‰\n"
sleep 1;screen -X -p 9 stuff "      self.iflist.each do |ifp| # å„ifpã®ã†ã¡\n"
sleep 1;screen -X -p 9 stuff "        (ifp == rifp) or        # å—ä¿¡ifpä»¥å¤–ã«\n"
sleep 1;screen -X -p 9 stuff "          ifp.send(pkt)         # é€ä¿¡ã™ã‚‹\n"
sleep 1;screen -X -p 9 stuff "      end\n"
sleep 2;screen -X -p 7 stuff "ãƒ‘ã‚±ãƒƒãƒˆã‚’å—ä¿¡ã—ãŸã‚‰ã€\n"
sleep 2;screen -X -p 7 stuff "å—ä¿¡ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ä»¥å¤–ã«\n"
sleep 2;screen -X -p 7 stuff "è»¢é€ã—ã¾ã™\n"
sleep 1;screen -X -p 9 stuff "    end\n  end\nend"
sleep 1;screen -X -p 9 stuff ":w\n"
sleep 2;screen -X -p 7 stuff "ã§ã¯ã“ã‚Œã‚’ center ã§å‹•ã‹ã—ã¾ã—ã‚‡ã†ã€‚\n"
sleep 2;screen -X -p 7 stuff "NW-DIY ã¯ ruby ã§æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã®ã§ã€\n"
sleep 2;screen -X -p 7 stuff "ã‚·ã‚§ãƒ«ã‹ã‚‰ ruby ã‚’æ‰±ã† irb ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã„ã¾ã™ã€‚\n"
sleep 2;screen -X -p 5 stuff "irb\n"
sleep 1;screen -X -p 5 stuff "require_relative 'switch.rb'\n"
sleep 1;screen -X -p 5 stuff "sw = Switch.new('north0')\n"
sleep 2;screen -X -p 7 stuff "Switch ã‚’ä½œã‚Šã¾ã—ãŸã€‚\n"
sleep 2;screen -X -p 7 stuff "north0 ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«ç¹‹ãŒã£ã¦ã¾ã™ã€‚\n"
sleep 2;screen -X -p 7 stuff "ãã‚Œã§ã¯ã“ã® Switch ã‚’å‹•ã‹ã—ã¾ã™ã€‚\n"
sleep 1;screen -X -p 5 stuff "\n"
sleep 1;screen -X -p 5 stuff "Thread.new { sw.job }\n"
sleep 2;screen -X -p 7 stuff "åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§Switch ã® job ã‚’å‹•ã‹ã—ã¾ã—ãŸã€‚\n"
sleep 2;screen -X -p 7 stuff "å³ä¸Šç”»é¢ã®ã‚³ãƒ¼ãƒ‰ãŒè£ã§å‹•ã„ã¦ã„ã¾ã™ã€‚\n"
sleep 2;screen -X -p 7 stuff "\nã“ã“ã§ã€east ã¨ west ã‚’ç¹‹ãè¾¼ã¿ã¾ã™ã€‚\n"
sleep 2;screen -X -p 5 stuff "sw.addif(['east0', 'west0'])\n"
sleep 3;screen -X -p 7 stuff "east ã‚„ west ã« ARP ãŒå±Šãã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚\n"
sleep 2;screen -X -p 7 stuff "ã—ã‹ã—ã¾ã  'south0' ã‚’åŠ ãˆã¦ãªã„ã®ã§ã€\n"
sleep 1;screen -X -p 7 stuff "south ã«ã¯å±Šã„ã¦ã„ã¾ã›ã‚“ã€‚\n"
sleep 2;screen -X -p 7 stuff "south ã‚‚ç¹‹ãè¾¼ã¿ã¾ã—ã‚‡ã†ã€‚\n"
sleep 1;screen -X -p 5 stuff "\n"
sleep 1;screen -X -p 5 stuff "sw.addif('south0')\n"
sleep 3;screen -X -p 7 stuff "south ã‚’ç¹‹ãã¨ ping å¿œç­”ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚\n"
sleep 1;screen -X -p 7 stuff "ã“ã‚Œã§ã²ã¨ã¾ãšå®Œæˆã§ã™ã€‚\n"
sleep 1;screen -X -p 7 stuff "..."
sleep 1;screen -X -p 7 stuff "..."
sleep 1;screen -X -p 7 stuff "..."
sleep 1;screen -X -p 7 stuff "\nã¾ã‚‹ã§æ˜”ã®ãƒªãƒ”ãƒ¼ã‚¿ã®ã‚ˆã†ã«\n"
sleep 1;screen -X -p 7 stuff "ä½™è¨ˆãªãƒ‘ã‚±ãƒƒãƒˆãŒæ±è¥¿ã«æ¼ã‚Œã¦ã„ã¾ã™ã­ã€‚\n"
sleep 1;screen -X -p 7 stuff "ã‚¤ãƒãƒ‰ã‚­ã®ã‚¹ã‚¤ãƒƒãƒã¯ã“ã‚Œã‚’æ¼ã‚‰ã•ãªã„ã‚ˆã†\n"
sleep 1;screen -X -p 7 stuff "å­¦ç¿’ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ã€‚\n"
sleep 3;screen -X -p 7 stuff "\nãã‚Œã§ã¯ã“ã‚Œã‹ã‚‰\n"
sleep 1;screen -X -p 7 stuff "ãã®å­¦ç¿’ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ©Ÿèƒ½ã‚’æ‹¡å¼µã—ã¾ã—ã‚‡ã†ã€‚\n"
sleep 2;screen -X -p 7 stuff "ãã®å‰ã«ã¡ã‚‡ã£ã¨ã€\n"
sleep 1;screen -X -p 7 stuff "ã“ã®ã‚¹ã‚¤ãƒƒãƒã¯æ­¢ã‚ã¦ãŠãã¾ã—ã‚‡ã†\n"
sleep 1;screen -X -p 5 stuff ""
sleep 1;screen -X -p 5 stuff "\n"
sleep 2;screen -X -p 7 stuff "center ã®ã‚¹ã‚¤ãƒƒãƒã‚’æ­¢ã‚ã¾ã—ãŸ\n"
sleep 2;screen -X -p 7 stuff "tcpdump ã®ç”»é¢ã‚‚ãšã‚‰ã—ã¦ãŠãã¾ã™\n"
sleep 1;screen -X -p 2 stuff "\n\n\n"
sleep 1;screen -X -p 4 stuff "\n\n\n"
sleep 1;screen -X -p 6 stuff "\n\n\n"
sleep 2;screen -X -p 7 stuff "ãã‚Œã§ã¯ã‚³ãƒ¼ãƒ‰ã‚’æ”¹é€ ã—ã¾ã™ã€‚\n"
sleep 2;screen -X -p 7 stuff "è£…ç½®ãŒã§ãã‚‹ã¨ãã«å­¦ç¿’ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç”¨æ„ã—ã¾ã™ã€‚\n"
sleep 1;screen -X -p 9 stuff "1Gjorequire 'nwdiy/timerhash'"
sleep 1;screen -X -p 9 stuff "jjo\n"
sleep 1;screen -X -p 9 stuff "  def initialize(*arg)\n"
sleep 1;screen -X -p 9 stuff "    super(*arg)\n"
sleep 2;screen -X -p 7 stuff "ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆæ™‚ã«\n"
sleep 2;screen -X -p 7 stuff "å­¦ç¿’ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œã‚Šã¾ã™\n"
sleep 1;screen -X -p 9 stuff "    @macdb = NwDiy::TimerHash.new\n"
sleep 1;screen -X -p 9 stuff "    @macdb.age = 10\n"
sleep 1;screen -X -p 9 stuff "    @macdb.update = false\n"
sleep 1;screen -X -p 7 stuff "å­¦ç¿’ã—ãŸãƒ‡ãƒ¼ã‚¿ã¯ 10 ç§’ã§ ageout ã•ã›ã¾ã—ã‚‡ã†ã€‚\n"
sleep 2;screen -X -p 9 stuff "  end\n"
sleep 2;screen -X -p 7 stuff "æ¬¡ã«ãƒ‘ã‚±ãƒƒãƒˆé€å—ä¿¡éƒ¨ã‚’æ”¹é€ ã—ã¾ã™ã€‚\n"
sleep 2;screen -X -p 9 stuff "jjjo\n"
sleep 2;screen -X -p 7 stuff "ãƒ‘ã‚±ãƒƒãƒˆã‚’å—ä¿¡ã—ãŸã‚‰ã¾ãš\n"
sleep 2;screen -X -p 7 stuff "é€ä¿¡å…ƒ MAC ã‚’ã‚­ãƒ¼ã«\n"
sleep 2;screen -X -p 7 stuff "å—ä¿¡ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ç™»éŒ²ã—ã¾ã™\n"
sleep 2;screen -X -p 9 stuff "      # å—ä¿¡ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ç™»éŒ²\n"
sleep 1;screen -X -p 9 stuff "      @macdb[pkt.src] = rifp\n"
sleep 2;screen -X -p 7 stuff "ä»Šåº¦ã¯é€ä¿¡å…ˆ MAC ã‚’ã‚­ãƒ¼ã«\n"
sleep 2;screen -X -p 7 stuff "é€ä¿¡ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æ¤œç´¢ã—ã¾ã™ã€‚\n"
sleep 2;screen -X -p 7 stuff "è¦‹ã¤ã‹ã£ãŸã‚‰ã€ãã“ã ã‘ã«è»¢é€ã—ã¾ã™\n"
sleep 2;screen -X -p 9 stuff "      # é€ä¿¡ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ç¢ºèª\n"
sleep 1;screen -X -p 9 stuff "      sifp = @macdb[pkt.dst]\n"
sleep 1;screen -X -p 9 stuff "      if sifp\n"
sleep 1;screen -X -p 9 stuff "        sifp.send(pkt)\n"
sleep 1;screen -X -p 9 stuff "        next\n"
sleep 1;screen -X -p 9 stuff "      end\n"
sleep 1;screen -X -p 9 stuff "j"
sleep 1;screen -X -p 9 stuff "j"
sleep 1;screen -X -p 9 stuff "j"
sleep 1;screen -X -p 9 stuff "j"
sleep 1;screen -X -p 9 stuff "j:w\n"
sleep 3;screen -X -p 7 stuff "ã“ã‚Œã§å­¦ç¿’ãƒ†ãƒ¼ãƒ–ãƒ«ãŒåŠ¹ãã‚ˆã†ã«ãªã£ãŸãƒã‚ºã§ã™ã€‚\n"
sleep 2;screen -X -p 7 stuff "ã§ã¯ã“ã‚Œã‚’å‹•ã‹ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚\n"
sleep 2;screen -X -p 5 stuff "irb\n"
sleep 1;screen -X -p 5 stuff "require_relative 'switch'\n"
sleep 1;screen -X -p 5 stuff "sw = Switch.new('north0')\n"
sleep 1;screen -X -p 5 stuff "Thread.new { sw.job }\n"
sleep 2;screen -X -p 7 stuff "å…ˆã»ã©ã¨åŒæ§˜ã« Switch ã‚’ä½œã£ã¦\n"
sleep 2;screen -X -p 7 stuff "å‹•ã‹ã—å§‹ã‚ã¾ã—ãŸã€‚\n"
sleep 2;screen -X -p 7 stuff "ã“ã“ã« east ã¨ west ã‚’ç¹‹ãè¾¼ã¿ã¾ã™ã€‚\n"
sleep 2;screen -X -p 5 stuff "\n"
sleep 1;screen -X -p 5 stuff "sw.addif(['east0', 'west0'])\n"
sleep 3;screen -X -p 7 stuff "east ã‚„ west ã« ARP ãŒå±Šãã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚\n"
sleep 2;screen -X -p 7 stuff "ã¾ã  south ã‚’ç¹‹ã„ã§ã„ãªã„ã®ã§ã€\n"
sleep 1;screen -X -p 7 stuff "ã•ã£ãã¨æŒ™å‹•ãŒåŒã˜ã§ã™ã€‚\n"
sleep 3;screen -X -p 7 stuff "ã§ã¯ south ã‚’ç¹‹ãè¾¼ã¿ã¾ã—ã‚‡ã†ã€‚\n"
sleep 1;screen -X -p 5 stuff "\n"
sleep 1;screen -X -p 5 stuff "sw.addif('south0')\n"
sleep 3;screen -X -p 7 stuff "south ã‚’ç¹‹ãã¨ ping å¿œç­”ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚\n"
sleep 1;screen -X -p 7 stuff "ãã—ã¦ east ã‚„ west ã®ãƒ‘ã‚±ãƒƒãƒˆãŒæ­¢ã¾ã‚Šã¾ã—ãŸã€‚\n"
sleep 1;screen -X -p 7 stuff "ã“ã‚Œã§å­¦ç¿’ã®æ©Ÿèƒ½ã‚‚å®Œæˆã§ã™ã€‚\n"
sleep 10;screen -X -p 7 stuff "\n10 ç§’ã”ã¨ã« 1 ç™ºã¥ã¤æ±è¥¿ã«å‡ºã¦ãã¦ã„ã¾ã™ã€‚\n"
sleep 1;screen -X -p 7 stuff "å­¦ç¿’ãƒ†ãƒ¼ãƒ–ãƒ«ãŒ 10 ç§’ã”ã¨ã«  ageout ã—ã¦ã„ã‚‹\n"
sleep 1;screen -X -p 7 stuff "æ§˜å­ãŒè¦‹ã¦ã¨ã‚Œã¾ã™ã€‚\n"
sleep 3;screen -X -p 7 stuff "\nã€ã¾ã¨ã‚ã€‘\n"
sleep 1;screen -X -p 7 stuff "ã“ã®ã‚ˆã†ã«ã€ãƒãƒ¼ãƒ‰ã‚„ã‚«ãƒ¼ãƒãƒ«ã‚’æ”¹é€ ã—ãªãã¦ã‚‚\n"
sleep 1;screen -X -p 7 stuff "æ—¢å­˜ã®æ©Ÿèƒ½ã‚’æ‹¡å¼µã™ã‚‹ã“ã¨ãŒå®¹æ˜“ã§ã™ã€‚\n"
sleep 1;screen -X -p 7 stuff "\n"
