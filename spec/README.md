## ruby 版 NW-DIY のトップモジュール

いろんなネットワーク機能をモデル化することで、
レイヤごとの処理を明快に定義することができるようになります。

ネットワーク機能を大別すると、パケットそのものの振舞いを定義した
パケットモジュールと、パケットの扱いを定義した機能モジュールの
二種類に分けることができます。

#### 【Nwdiy::Packet】

パケットそのものの構成や振舞いを定義したパケットモジュールです。

バイナリデータとの相互変換や、データの梱包あるいは梱包したデータの取り出し、文字列表現やコネクション情報などがあります。

#### 【Nwdiy::Func】

パケットの特定のレイヤ (パケット種別) を処理する機能モジュールです。

たとえばイーサネットインターフェースや L2 スイッチは、
イーサネットフレームである Nwdiy::Packet::Ethernet を処理するので、
Nwdiy::Func::Ethernet の機能を含んでいます。

たとえば IP インターフェースやルータ, NAT などは、
IP パケットである Nwdiy::Packet::IPv4 を処理するので、
Nwdiy::Func::IPv4 の機能を含んでいます。

この機能モジュールをインクルードしたクラスのインスタンスは、
パケットのフィールド名とその値あるいは別名を指定することで
梱包されたデータの中身を処理するクラスを設定できます。
たとえばイーサネットインターフェースであるインスタンス eth0 にとって
eth0.ipv4 は IPv4 フレームを扱うインスタンスですし、
eth0.vlan(16).ipv6 は VLAN id 16 上で IPv6 を扱うインスタンスです。
下記の例では、階層として示しています。

この機能モジュールを持つインスタンスは、パイプで繋ぐことができます。
下記の例で、ハイフン (--) で示しています。

##### 例

eth2 のセグメントを、EtherIP を使って、eth1 の先のXXXと繋ぐ。

    +----------+      +------+
    | etherip  | ---- | eth2 |
    +----------+      +------+
    |   ipv4   |      |  OS  |
    +----------+      +------+
    |   eth1   |
    +----------+
    |    OS    |
    +----------+

```ruby
  irb> OS.eth("eth1").ip("192.0.2.1/24").etherip | OS.eth("eth2")
```

##### 例

EtherIP にファイアウォールと QoS を導入して、eth2 を守る。

                           +----------+    +-----+    +------+    +------+
                           | etherip  | -- | fwB | -- | qosB | -- | eth2 |
                           +----------+    +-----+    +------+    +------+
                           |   ipv4   |                           |  OS  |
    +------+    +-----+    +----------+                           +------+
    | eth1 | -- | fwA | -- |   ethA   |
    +------+    +-----+    +----------+
    |  OS  |
    +------+

```ruby
  irb> fwA = Firewall.new(some settings)
  irb> fwB = Firewall.new(some settings)
  irb> qosB = QOS.new(some settings)
  irb> ethA = Ethernet.new("ethA")
  irb> OS.eth("eth1") | fwA | ethA
  irb> ethA.ip("192.0.2.1/24").ethip | fwB | qosB | OS.eth("eth2")
```

##### 例

スイッチを介して DNS を引き、HTTP でデータを取得する。
いちおう外部からもアクセス可能。

    +--------+ +--------+                               +-------+ +-----+
    | brwser | | resolv |                               | httpd | | dns |
    +--------+ +--------+                               +-------+ +-----+
    |  tcp   | |  udp   |                               |  tcp  | | udp |
    +--------+-+--------+    +---------------------+    +-------+-+-----+
    |       ipv4A       |    |       bridge        |    |     ipv4B     |
    +-------------------+    +-----+-+-----+-+-----+    +---------------+
    |        ethA       | -- | eth | | eth | | eth | -- |      ethB     |
    +-------------------+    +-----+ +-----+ +-----+    +---------------+
                                     | OS  |
                                     +-----+

```ruby
  irb> ethA = Ethernet.new("ethA")
  irb> ethB = Ethernet.new("ethB")
  irb> bridge = Bridge.new
  irb> ethA | bridge.eth[0]
  irb> bridge.eth[1] = OS.eth("eth0")
  irb> bridge.eth[2] | ethB
  irb> brwser = Browser.new
  irb> httpd = Httpd.new
  irb> resolv = Resolver.new
  irb> dns = DNS.new
  irb> ethA.ip[0] = "192.0.2.1/24"
  irb> ethA.ip[0].tcp.bind(brwser)
  irb> ethA.ip[0].udp.bind(resolv)
  irb> ethB.ip[0] = "198.58.100.1/24"
  irb> ethB.ip[0].tcp.bind(httpd, 80)
  irb> ethB.ip[0].udp.bind(dns, 53)
```

#### 例

ルータを介して DNS を引き、HTTP でデータを取得する。
IPv4 インスタンスをパイプで繋いだりイーサネットインスタンスを
パイプで繋いだり、左右で違いがあるのは、ただ単純にどっちでもできる
という例示のためであり、この構成への必然性はありません。

    +--------+ +--------+            +--------+            +-------+ +-----+
    | brwser | | resolv |            | ospfv2 |            |  http | | dns |
    +--------+ +--------+    +-------+--------+-------+    +-------+ +-----+
    |  tcp   | |   udp  |    |         router         |    |  tcp  | | udp |
    +--------+-+--------+    +------+-+------+-+------+    +-------+-+-----+
    |       ipv4A       | -- | ipv4 | | ipv4 | | ipv4 | -- |     ipv4B     |
    +-------------------+    +------+ +------+ +------+    +---------------+
                                      | eth1 |
                                      +------+
                                      |  OS  |
                                      +------+

```ruby
  irb> ipv4A = IPv4.new("192.0.2.2/24")
  irb> ipv4B = IPv4.new("203.0.113.2/24")
  irb> router = Router.new
  irb> router.ip[0] = "192.0.2.1/24"
  irb> router.ip[1] = "198.51.100.1/24"
  irb> router.ip[2] = "203.0.113.1/24"
  irb> ipv4A | router.ip[0]
  irb> router.ip[1] = OS.eth("eth1").ip("198.51.100.2/24")
  irb> router.ip[2] | ipv4B
  irb> router.ospf.routerId = "192.0.2.1"
  irb> brwser = Browser.new
  irb> httpd = Httpd.new
  irb> resolv = Resolver.new
  irb> dns = Dns.new
  irb> ipv4A.tcp.bind(brwser)
  irb> ipv4B.tcp.bind(httpd, 80)
  irb> ipv4A.udp.bind(resolv)
  irb> ipv4B.udp.bind(dns, 53)
```

#### 例

送信元 NAT を挟んで、おうちの外にアクセスする。

              +---------------+
              |     router    |
              +------+-+------+
              | ipv4 | | snat |
              +------+ +------+
              | eth1 | | eth2 |
              +------+ +------+
    ホーム -- |  OS  | |  OS  | -- 外部
    ネット    +------+ +------+    インターネット

```ruby
  irb> router = Router.new
  irb> snat = Snat.new
  irb> snat.xxx = xxx (いろいろ設定)
  irb> OS.eth("eth1").ipv4 = router.ip[0] = "192.0.2.1/24"
  irb> OS.eth("eth2").ipv4 = router.ip[1] = snat
```

##### 例

宛先 NAT を挟んで、DMZ のサーバーにアクセスさせる。

              +---------------+
              |     router    |
              +------+-+------+
              | dnat | | ipv4 |
              +------+ +------+
              | eth1 | | eth2 |
              +------+ +------+
    外部   -- |  OS  | |  OS  | -- サーバーゾーン
    ネット    +------+ +------+

```ruby
  irb> router = Router.new
  irb> dnat = Dnat.new
  irb> dnat.xxx = xxx (いろいろ設定)
  irb> OS.eth("eth1").ipv4 = router.ip[0] = dnat
  irb> OS.eth("eth2").ipv4 = router.ip[1] = "198.51.100.1/24"
```

- 用語
	- 上位・下位: OSI 階層に沿って上下を区別する。
		沿わないものは「左右」であり、
		左右を持つ機能はおのおので「左」と「右」の役割を定義する。

- OS
	- グローバル変数として、起動時から 1 個だけ存在する。生成/削除しない。
	- 上位に eth のインスタンスを持つ
		- 実在する eth インターフェースと PF_PACKET でパケットを交換する。
		- 将来どっかの LKM 製品と連携するとき、tap を使う。
	- eth 以外のインターフェース。ATM/FrameRelay はもうないかな。でも
		トンネル系の POINTOPOINT インターフェースはあり得る。

- eth
	- パケット取得, 送信方法いろいろ
		- Ethernet frame を扱う。
	- 自分の MAC アドレスは、0 個あるいは 1 個のみ。
		- 自分のアドレスを持つとき、上位のインスタンスを持つことができる。
		- 持たなくても、中継やパケットキャプチャができる。
	- 下位インスタンスは、無し, OS, パイプ, EtherIP や L2TP のような
		L2 トンネルなど。
		- 下位インスタンスとの接続
			- 下位が無のとき (一時的な状態)
				- Ethernet frame は送受信できない。(でぶぬる)
			- 下位がパイプのとき
				- Ethernet frame はパイプで送受信する。
			- 下位が OS のとき
				- OS に実在するインターフェースから、名前指定でインスタンスを生成する。
				- tap で名前指定で、実インターフェースとインスタンスを生成する。
			- 下位が L2 インスタンスのとき
				- 下位の L2 インスタンスから vlan id などを指定してインスタンスを
				生成する。あるいは vlan id など付与して下位に接続する。
				- 自 MAC は自分で持っていても良い。持ってないときは、
					下位の L2 インスタンスのものを流用する。
					別途自分で持ってても良い。
				- 下位 L2 インスタンスから受信した Ethernet Frame は、
					その vlan id などを剥がしてから利用する。
				- 下位 L2 インスタンスに送信する Ethernet Frame は、
					その vlan id などを履かせてから送信する。
			- 下位が L2 トンネルのとき
				- トンネルインスタンスから自動生成する。
				- パケットは L2 トンネルで送受信する。
		- 下位インスタンスへパケット送受信
			- 下位に送信する Ethernet Frame は、自分宛じゃないもの、
				or MC bit ON のもの。
			- 受信した Ethernet Frame も上記のものは転送する。
				このとき受信元には転送(折り返し)しない。
			- 受信時に学習テーブルを生成し、送信時にはこれを利用する。
	- 上位には eth ホスト, VLAN, QinQ などの L2 モノと、それ以外がある。
		- MAC を持たないとき、上位に持てるのは L2 モノのみ。
		- MAC を持たないとき、上位には全ての Ethernet Frame も渡す。
		- MAC を持つとき、L2 系上位には全ての Ethernet frame を渡す。
			それ以外の上位には自分宛, MC bit ON のものだけを渡す。

- eth ホスト
	- 後述するホストとは異なり、ひとつの eth ホストで下位に
		複数の eth インターフェースを生やすことができる。
		- 基本的に MAC アドレスは、下位の eth インターフェースが持つ。
			ただし昔の Sun Workstation などを模擬るために
			ここで MAC アドレスを持つというパターンもあって良い。
			- eth ホストと下位の eth インターフェース、どっちかあるいは両方は
				MAC を持っていること。
	- 上位については、eth として振る舞う。

- firewall
	- いろんなパケット種別を扱う。ただし firewall 系インスタンスは
		自力でフレームの階層をたどるので、基本的に最下位の Ethernet frame を
		流すようにしておけばよい。
	- パケット送受信は左右一本ずつのパイプを使う。パイプ接続の都合上、
		パイプの左右インスタンスが扱うパケット種別を一致させる必要がある。
	- IPCOM では in/out でフィルタを区別しているところを、
		NW-DIY firewall では右向きを forward, 左向きを backward として区別する。

- qos
	- 外部要件は firewall と同じ。

- IPv4 インターフェース, IPv6 インターフェース
	- ARP, IPv4, ICMP/IPv4 パケットを扱う。
	- アドレスは 1 個だけ持つ。マスク長も一緒に。
	- 下位インスタンスは、0 個あるいは 1 個。その種類は OS, パイプ,
		eth や vlan などの L2, ipip などの L3 トンネル, など。
		- 下位が無しのとき (一時的な状態)
			- BROADCAST か POINTOPOINT か不明。
			- IP パケットは送受信できない (でぶぬる)
		- 下位が OS のとき
			- OS から名前指定でインスタンスを生成する。
				ただし対象は tun や P2P 系などのうちダイレクトに L3 を扱うものに限る。
			- BROADCAST か POINTOPOINT か、物理デバイスに沿う。
			- パケットは pcap/tun などで送受信する。
		- 下位がパイプのとき
			- POINTOPOINT になる。
		- 下位が eth などの L2 インターフェースのとき
			- MAC アドレスを持ってないと、生やしたり接続したりできない。
			- BROADCAST か POINTOPOINT か、下位インターフェースに沿う。
			- 下位の L2 から proto を指定してインスタンスを生成する。
				あるいは単純に接続する (proto はインスタンスが知っている)
			- ひとつの下位インスタンスから複数の IPv4 インスタンスを生やせる。
		- 下位が L3 トンネルのとき
			- BROADCAST か POINTOPOINT か、トンネルの方式に沿う。
			- 下位からインスタンス生成する。あるいは単純に接続する。
	- 下位インターフェースひとつから複数の IPv4 インターフェースを
		生やせる。それぞれアドレスが違うようにしてないと。
	- BROADCAST のとき。
		- 送信前に ARP 解決する。
		- ネクストホップを持っとくこと。推奨するが必須にはしない。
	- 上位は tcp, udp などの L4 もの, トンネル類を持つことができる。
	- 受信パケット

    | L2宛先   | L3宛先       | 処理                 |
    |:--------:|:------------:|:--------------------:|
    | 自分     | 自分         | 受信                 |
    | 自分     | 自サブネット | * リダイレクト       |
    | 自分     | 他サブネット | * ルーティング       |
    | 自分     | MC(参加)     | 受信, * ルーティング |
    | 自分     | MC(無視)     | 無視                 |
    | 他人     | -            | 無視                 |
    | MC(参加) | 自分         | 受信                 |
    | MC(参加) | 自サブネット | 無視                 |
    | MC(参加) | 他サブネット | 無視                 |
    | MC(参加) | MC(参加)     | 受信, * ルーティング |
    | MC(参加) | MC(無視)     | 無視                 |
    | MC(無視) | -            | 無視                 |
    | (P2P)    | 自分         | 受信                 |
    | (P2P)    | 他人         | * ルーティング       |
    | (P2P)    | MC(参加)     | 受信, * ルーティング |
    | (P2P)    | MC(無視)     | 無視                 |

		ただし "*" は設定による。
		リダイレクトはインターフェースごとに設定し、
		ルーティングやマルチキャストルーティングはルータで設定する。

- NAT インターフェース
	- IPv4 や IPv6 インターフェース同様
	- 細かいこと言えば、src nat と dst nat と dst mat がある。
	- 細かいこと言えば、nat と napt がある。

- ホスト・ルータ
	- ルーティング ON/OFF、さらにマルチキャストルーティング ON/OFF 設定あり。
	- ひとつのホスト・ルータで、下位に複数の IPv4/IPv6 インターフェースを
		生やすことができる。
	- 上位については、IPv4/IPv6 インターフェースと同様。
	- パケット送信時、そして rout=ON での中継時は、
		宛先アドレスからルーティングテーブルを検索して
		出力先インターフェースやネクストホップを決める。
		ECMP 時はパケットに添付したコネクション情報を参考にする。
		パケットの送信元アドレスが分からないときは、
		出力先インターフェースのアドレスを使う。

- etherip
	- EtherIP パケットと Ethernet Frame を扱う L2 インスタンス。
	- 下位インスタンスは、ホストあるいは IPv4/IPv6 インターフェース。
	- ローカル側アドレスは、
		- 下位インスタンスがインターフェースなら、省略してもいい (流用)。
		- 下位インスタンスがホスト・ルータなら、省略できない (選ばねば)。
		- 設定した場合、下位インスタンスと食い違っててもいい。
	- 対向側アドレスは、このインスタンスで設定する。
	- 上位から ARP Request や ICMPv6 ns が来たら、キャッシュできるといいな。

- vxlan
	- 外部要件は、下記を除き etherip と同じ。
	- vxlan id は、…
	- 対向先アドレスは、…

- TCP
	- TCP パケットを扱う。
	- 下位インスタンスは、ホスト, IPv4/IPv6 インターフェース, OS いずれか。
	- 下位インスタンスから自動生成できる。それ以外にも、生成してから
		下位インスタンスに載せてもいい。
	- 下位インスタンスは 1 個だけ。生成の途中経過として
		一時的に 0 個もアリだが、送受信はできない。
	- パイプは…下位…なのか？ 直感的に、あまりピンと来ない。
		そもそもパイプするのか？
	- 上位インスタンスにはパケットではなくストリームを提供する。
	- 自分のポート番号 1 個だけ持つ。
	- 対向先のポート番号は、
		- インスタンス作成時にポート番号を指定して "connect" することができる。
		- 作成時には Listen するインスタンスを作り、そこから accept で得る。

- UDP
	- UDP パケットを扱う。
	- 下位インスタンスについては TCP 同様。
		- 上位インスタンスにはデータグラムすなわちパケットを提供する。
	- 自分のポート番号1 個だけ持つ。
	- 作成時に対向先のポート番号を指定して "connect" することができる。
	- 作成時に上位インスタンス, 上位インスタンスを生成するメソッド
		あるいはクラスを持ち、"recv" できる。
